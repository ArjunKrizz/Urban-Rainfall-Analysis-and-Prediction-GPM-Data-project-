// Load the Shapefile for zones
var hyderabad_zones = ee.FeatureCollection("projects/ee-arjunkrishna/assets/ghmc-zones");

// Load the GPM dataset
var gpm_dataset = ee.ImageCollection('NASA/GPM_L3/IMERG_V06');

// Define the date range
var startDate = '2017-01-01';
var endDate = '2023-01-01';

// Filter the GPM dataset for the specified date range
var filtered_dataset = gpm_dataset.filterDate(startDate, endDate);

// Define a function to calculate the daily precipitationCal for each zone
var calculatePrecipitation = function(image) {
  // Get the date of the image
  var date = ee.Date(image.get('system:time_start')).format('yyyy-MM-dd');
  
  // Reduce the image to get the sum of precipitationCal for each zone
  var stats = hyderabad_zones.map(function(zone) {
    var precipitation = image.reduceRegion({
      reducer: ee.Reducer.sum(),
      geometry: zone.geometry(),
      scale: 11132,  // Resolution of the dataset
      bestEffort: true
    });
    
    return ee.Feature(null, {
      'system:time_start': date,
      'zone_name': zone.get('name'),
      'precipitationCal': precipitation.get('precipitationCal')
    });
  });
  
  return stats;
};

// Map over the filtered dataset to calculate daily precipitationCal for each zone
var dailyPrecipitation = filtered_dataset.map(calculatePrecipitation).flatten();

// Export the results as a CSV file
Export.table.toDrive({
  collection: dailyPrecipitation,
  description: 'precipitation_calculated_zones',
  folder: 'GEE_exports',
  fileFormat: 'CSV'
});
